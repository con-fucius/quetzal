<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quetzal Research Assistant</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Highlight.js for code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
    <!-- Custom Stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/gradient-blue.css') }}">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Outfit', sans-serif;
            line-height: 1.4;
            height: 100vh;
            overflow: hidden;
            font-size: 14px;
        }
        
        /* Loader styling */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s, visibility 0.5s;
        }
        
        .loader {
            width: 40px;
            height: 40px;
            border: 3px solid transparent;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        /* Appearance options styling */
        .appearance-option {
            transition: all 0.2s ease;
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .appearance-option:hover {
            background-color: var(--surface-light-hover);
        }
        
        /* Emergency reset button */
        .emergency-reset {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ef4444;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none;
        }
        
        /* Fix for modal z-index to ensure they're above everything else */
        .modal-overlay {
            z-index: 1000 !important;
        }
    </style>
    
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <!-- DOMPurify for sanitization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <!-- Highlight.js for code highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (e) {
                        console.error(e);
                    }
                }
                return hljs.highlightAuto(code).value;
            }
        });
    </script>
</head>
<body>
    <div class="chat-container">
        <!-- Hide the theme toggle button since we now have it in the sidebar -->
        <button class="theme-toggle hidden" id="themeToggle">
            <i class="fas fa-moon"></i>
        </button>
        
        <!-- Emergency reset button - only visible when modals are stuck -->
        <button id="emergency-reset" class="emergency-reset">
            <i class="fas fa-exclamation-triangle"></i>
        </button>
        
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <span class="logo-text">QUETZAL</span>
            </div>
            
            <button id="new-chat-btn" class="new-chat-btn">
                <i class="fas fa-plus"></i> New Chat
            </button>
            
            <div id="chat-list" class="nav-section">
                <div class="nav-title">Recent Chats</div>
                <!-- Chat history will be populated here -->
            </div>
            
            <div class="nav-section">
                <div class="nav-title">Knowledge Base</div>
                
                <!-- URL Processing section -->
                <div class="nav-button" id="process-url-toggle">
                    <i class="fas fa-globe"></i> Process URL
                </div>
                <div id="url-process-section" class="hidden p-3 mx-2 mt-1 bg-opacity-10 rounded-lg" style="background-color: var(--surface-light);">
                    <input type="text" id="url-input" placeholder="Enter URL" 
                           class="form-input mb-2">
                    <button id="process-url-btn" 
                            class="btn-primary w-full py-2 flex items-center justify-center rounded-md">
                        <i class="fas fa-arrow-right mr-2"></i> Process URL
                    </button>
                <div id="url-status" class="mt-2 text-sm"></div>
            </div>
            
                <!-- File Upload section -->
                <div class="nav-button" id="upload-doc-toggle">
                    <i class="fas fa-file-upload"></i> Upload Document
                </div>
                <div id="document-upload-section" class="hidden p-3 mx-2 mt-1 bg-opacity-10 rounded-lg" style="background-color: var(--surface-light);">
                <form id="upload-form" enctype="multipart/form-data">
                        <input type="file" id="file-input" name="file" accept=".txt,.md,.pdf" 
                               class="form-input mb-2">
                        <select id="folder-select" class="form-select mb-2">
                            <option value="">Select Folder (Optional)</option>
                            <!-- Folders will be populated here -->
                        </select>
                        <button type="submit" 
                                class="btn-primary w-full">
                            Upload
                        </button>
                </form>
                <div id="file-status" class="mt-2 text-sm"></div>
            </div>
                
                <!-- Folder Organization section -->
                <div class="nav-button" id="folder-management-toggle">
                    <i class="fas fa-folder"></i> Knowledge Library
                </div>
                <div id="folder-management-section" class="hidden p-3 mx-2 mt-1 bg-opacity-10 rounded-lg" style="background-color: var(--surface-light);">
                    <button id="create-folder-btn" class="mb-2 btn-primary w-full">
                        <i class="fas fa-folder-plus"></i> Create Folder
                    </button>
                    <div id="folder-list" class="mt-2">
                        <!-- Folders will be populated here -->
                    </div>
                </div>
        </div>
        
            <div class="nav-section">
                <div class="nav-title">Settings</div>
                <div class="nav-button" id="preferences-toggle">
                    <i class="fas fa-sliders-h"></i> Preferences
            </div>
                <div class="nav-button" id="appearance-toggle">
                    <i class="fas fa-paint-brush"></i> Appearance
                </div>
                <div id="appearance-options" class="hidden p-3 mx-2 mt-1 bg-opacity-10 rounded-lg" style="background-color: var(--surface-light);">
                    <div class="flex flex-col gap-2">
                        <button id="light-mode-btn" class="appearance-option w-full py-2 px-3 rounded-md flex items-center justify-between">
                            <span><i class="fas fa-sun mr-2"></i> Light Mode</span>
                            <i class="fas fa-check text-primary-color" id="light-mode-check"></i>
                        </button>
                        <button id="dark-mode-btn" class="appearance-option w-full py-2 px-3 rounded-md flex items-center justify-between">
                            <span><i class="fas fa-moon mr-2"></i> Dark Mode</span>
                            <i class="fas fa-check text-primary-color hidden" id="dark-mode-check"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="chat-main">
            <div class="chat-header">
                <div class="chat-title" id="current-chat-title">New Chat</div>
                <div class="chat-actions">
                    <button class="action-btn" id="export-btn" title="Export Chat">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="action-btn" id="share-btn" title="Share Chat">
                        <i class="fas fa-share-alt"></i>
                    </button>
                    <div class="relative" id="more-actions-container">
                        <button class="action-btn" id="more-actions-btn" title="More Actions">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <div id="more-actions-menu" class="hidden absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-10" style="background-color: var(--surface-light);">
                            <button class="block px-4 py-2 text-sm w-full text-left hover:bg-gray-100" id="rename-chat-btn" style="color: var(--text-primary);">
                                <i class="fas fa-edit mr-2"></i> Rename Chat
                            </button>
                            <button class="block px-4 py-2 text-sm w-full text-left hover:bg-gray-100" id="delete-chat-btn" style="color: var(--text-primary);">
                                <i class="fas fa-trash mr-2"></i> Delete Chat
                </button>
            </div>
                    </div>
            </div>
        </div>
        
            <!-- Chat Messages History -->
            <div class="chat-history">
                <!-- Welcome message shown when no messages -->
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center">
                    <h1 class="text-4xl font-bold mb-4 text-gradient">Quetzal</h1>
                    <p class="text-lg max-w-xl">Your AI research assistant. Ask any question based on your uploaded documents or processed URLs.</p>
                </div>
                
                <!-- Messages will be added here -->
                <div id="messages-container" class="hidden">
                    <!-- Messages will be dynamically added here -->
                </div>
                
                <!-- Typing indicator -->
                <div id="typing-indicator" class="typing-indicator hidden">
                    <span>Quetzal is thinking</span>
                    <div class="dots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Input -->
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea id="query-input" placeholder="Send a message..." rows="1" class="chat-input"></textarea>
                    <button id="query-btn" class="chat-send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="chat-options">
                    <button class="chat-option-btn" id="voice-input-btn">
                        <i class="fas fa-microphone"></i> Voice
                    </button>
                    <button class="chat-option-btn" id="format-btn">
                        <i class="fas fa-font"></i> Format
                    </button>
                    <div></div>
                    <button class="chat-option-btn" id="help-btn">
                        <i class="fas fa-question-circle"></i> Help
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Templates -->
    <div id="folder-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Create New Folder</h3>
                <button class="modal-close" id="folder-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="folder-name">Folder Name</label>
                    <input type="text" id="folder-name" class="form-input" placeholder="Enter folder name">
                </div>
                <div class="form-group">
                    <label class="form-label" for="folder-description">Description (Optional)</label>
                    <textarea id="folder-description" class="form-input" rows="3" placeholder="Describe the folder's purpose"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="parent-folder">Parent Folder (Optional)</label>
                    <select id="parent-folder" class="form-select">
                        <option value="">None (Top Level)</option>
                        <!-- Parent folders will be populated here -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel" id="folder-modal-cancel">Cancel</button>
                <button class="modal-btn btn-primary" id="folder-modal-save">Create Folder</button>
            </div>
        </div>
    </div>
    
    <div id="export-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Export Chat</h3>
                <button class="modal-close" id="export-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="export-format">Format</label>
                    <select id="export-format" class="form-select">
                        <option value="text">Plain Text (.txt)</option>
                        <option value="markdown">Markdown (.md)</option>
                        <option value="pdf">PDF Document (.pdf)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="export-content">What to Include</label>
                    <select id="export-content" class="form-select">
                        <option value="all">All Messages</option>
                        <option value="assistant">Assistant Messages Only</option>
                        <option value="last">Last Message Only</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel" id="export-modal-cancel">Cancel</button>
                <button class="modal-btn btn-primary" id="export-modal-save">Export</button>
            </div>
        </div>
    </div>
    
    <div id="rename-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Rename Chat</h3>
                <button class="modal-close" id="rename-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="new-chat-title">New Title</label>
                    <input type="text" id="new-chat-title" class="form-input" placeholder="Enter new title">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel" id="rename-modal-cancel">Cancel</button>
                <button class="modal-btn btn-primary" id="rename-modal-save">Rename</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="confirm-modal-title">Confirm Action</h3>
                <button class="modal-close" id="confirm-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirm-modal-message">Are you sure you want to proceed?</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel" id="confirm-modal-cancel">Cancel</button>
                <button class="modal-btn btn-primary" id="confirm-modal-confirm">Confirm</button>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let currentChatId = null;
        let folders = [];
        let documents = [];
        let currentTheme = localStorage.getItem('theme') || 'light';
        
        // Initialize theme
        document.addEventListener('DOMContentLoaded', function() {
            // Emergency reset button
            const emergencyResetBtn = document.getElementById('emergency-reset');
            
            // Show emergency button after 10 seconds if needed
            setTimeout(function() {
                const hasVisibleModals = Array.from(document.querySelectorAll('.modal-overlay')).some(modal => 
                    !modal.classList.contains('hidden')
                );
                
                if (hasVisibleModals) {
                    emergencyResetBtn.style.display = 'flex';
                }
            }, 10000);
            
            // Emergency reset functionality
            emergencyResetBtn.addEventListener('click', function() {
                closeAllModals();
                emergencyResetBtn.style.display = 'none';
            });
            
            // Rest of initialization code
            applyTheme(currentTheme);
            loadFolders();
            loadChats();
            initializeUI();
            closeAllModals();
        });
        
        // Theme toggle
        function applyTheme(theme) {
            const root = document.documentElement;
            const themeToggle = document.getElementById('themeToggle');
            
            if (theme === 'dark') {
                root.classList.add('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                root.classList.remove('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
            
            localStorage.setItem('theme', theme);
            currentTheme = theme;
        }
        
        function initializeUI() {
            // Initialize UI components and event listeners
            initializeModals();
            initializeToggles();
            initializeThemeToggle();
            initializeFolderManagement();
            initializeChat();
            autoExpandTextarea();
            
            // Add emergency close button for modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeAllModals();
                }
            });
        }
        
        function closeAllModals() {
            const modals = document.querySelectorAll('.modal-overlay');
            modals.forEach(modal => {
                modal.classList.add('hidden');
            });
        }
        
        function initializeThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            themeToggle.addEventListener('click', function() {
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                applyTheme(newTheme);
            });
        }
        
        function initializeModals() {
            // Handle all modals
            const modals = document.querySelectorAll('.modal-overlay');
            
            modals.forEach(modal => {
                const closeBtn = modal.querySelector('.modal-close');
                const cancelBtn = modal.querySelector('.btn-cancel');
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        modal.classList.add('hidden');
                    });
                }
                
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', function() {
                        modal.classList.add('hidden');
                    });
                }
                
                // Add click outside to close
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            });
            
            // Handle specific modal functionality
            initializeFolderModal();
            initializeExportModal();
            initializeRenameModal();
            initializeConfirmModal();
        }
        
        function initializeToggles() {
            // Setup all expandable sections
            const toggleButtons = [
                { toggle: 'process-url-toggle', section: 'url-process-section' },
                { toggle: 'upload-doc-toggle', section: 'document-upload-section' },
                { toggle: 'folder-management-toggle', section: 'folder-management-section' },
                { toggle: 'appearance-toggle', section: 'appearance-options' }  // Added appearance toggle
            ];
            
            toggleButtons.forEach(item => {
                const toggleBtn = document.getElementById(item.toggle);
                const section = document.getElementById(item.section);
                
                toggleBtn.addEventListener('click', function() {
                    section.classList.toggle('hidden');
                });
            });
            
            // More actions menu
            const moreActionsBtn = document.getElementById('more-actions-btn');
            const moreActionsMenu = document.getElementById('more-actions-menu');
            
            moreActionsBtn.addEventListener('click', function() {
                moreActionsMenu.classList.toggle('hidden');
            });
            
            // Close more actions menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('#more-actions-container') && !moreActionsMenu.classList.contains('hidden')) {
                    moreActionsMenu.classList.add('hidden');
                }
            });
            
            // Initialize appearance mode buttons
            initializeAppearanceOptions();
        }
        
        function initializeAppearanceOptions() {
            const lightModeBtn = document.getElementById('light-mode-btn');
            const darkModeBtn = document.getElementById('dark-mode-btn');
            const lightModeCheck = document.getElementById('light-mode-check');
            const darkModeCheck = document.getElementById('dark-mode-check');
            
            // Set initial state based on current theme
            updateAppearanceChecks();
            
            // Light mode button
            lightModeBtn.addEventListener('click', function() {
                applyTheme('light');
                updateAppearanceChecks();
            });
            
            // Dark mode button
            darkModeBtn.addEventListener('click', function() {
                applyTheme('dark');
                updateAppearanceChecks();
            });
        }
        
        function updateAppearanceChecks() {
            const lightModeCheck = document.getElementById('light-mode-check');
            const darkModeCheck = document.getElementById('dark-mode-check');
            
            if (currentTheme === 'light') {
                lightModeCheck.classList.remove('hidden');
                darkModeCheck.classList.add('hidden');
            } else {
                lightModeCheck.classList.add('hidden');
                darkModeCheck.classList.remove('hidden');
            }
        }
        
        // Initialize markdown parser with syntax highlighting
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                } else {
                    return hljs.highlightAuto(code).value;
                }
            },
            breaks: true
        });
        
        async function sendQuery() {
            const queryInput = document.getElementById('query-input');
            const query = queryInput.value.trim();
            
            if (!query) {
                return;
            }
            
            if (!currentChatId) {
                await createNewChat();
            }
            
            // Show typing indicator
            document.getElementById('typing-indicator').classList.remove('hidden');
            
            // Render user message immediately
            const userMessage = {
                content: query,
                role: 'user',
                timestamp: new Date().toISOString()
            };
            
            renderMessage(userMessage);
            
            // Clear input
            queryInput.value = '';
            
            try {
                // Use the query endpoint instead of the messages endpoint
                const response = await fetch(`/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        chat_id: currentChatId
                    }),
                });
                
                const result = await response.json();
                
                // Hide typing indicator
                document.getElementById('typing-indicator').classList.add('hidden');
                
                if (result.success) {
                    // Hide welcome screen if visible
                    document.getElementById('welcome-screen').classList.add('hidden');
                    document.getElementById('messages-container').classList.remove('hidden');
                    
                    // Render assistant message
                    const assistantMessage = {
                        content: result.answer,
                        role: 'assistant',
                        timestamp: new Date().toISOString(),
                        sources: result.sources || []
                    };
                    
                    renderMessage(assistantMessage);
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                // Hide typing indicator
                document.getElementById('typing-indicator').classList.add('hidden');
                alert(`Error: ${error.message}`);
            }
        }
        
        function renderMessage(message) {
            const messagesContainer = document.getElementById('messages-container');
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.role}`;
            
            // Message header with role and timestamp
            const messageHeader = document.createElement('div');
            messageHeader.className = 'message-header';
            
            const roleIcon = document.createElement('div');
            roleIcon.className = 'role-icon';
            roleIcon.innerHTML = message.role === 'assistant' ? 
                '<i class="fas fa-robot"></i>' : 
                '<i class="fas fa-user"></i>';
            messageHeader.appendChild(roleIcon);
            
            const roleName = document.createElement('div');
            roleName.className = 'role-name';
            roleName.textContent = message.role === 'assistant' ? 'Quetzal' : 'You';
            messageHeader.appendChild(roleName);
            
            if (message.timestamp) {
                const timestamp = document.createElement('div');
                timestamp.className = 'timestamp';
                timestamp.textContent = formatTimestamp(message.timestamp);
                messageHeader.appendChild(timestamp);
            }
            
            messageElement.appendChild(messageHeader);
            
            // Message content
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            if (message.role === 'assistant') {
                // Parse markdown for assistant messages
                messageContent.innerHTML = DOMPurify.sanitize(marked.parse(message.content));
                
                // Apply syntax highlighting to code blocks
                messageContent.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                });
                
                // Add copy buttons to code blocks
                messageContent.querySelectorAll('pre').forEach((pre) => {
                    const codeBlock = document.createElement('div');
                    codeBlock.className = 'code-block';
                    
                    const codeHeader = document.createElement('div');
                    codeHeader.className = 'code-header';
                    
                    const codeLanguage = pre.querySelector('code').className.replace('hljs ', '');
                    const languageSpan = document.createElement('span');
                    languageSpan.textContent = codeLanguage || 'code';
                    codeHeader.appendChild(languageSpan);
                    
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-code-button';
                    copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                    copyButton.addEventListener('click', function() {
                        const code = pre.querySelector('code').textContent;
                        navigator.clipboard.writeText(code).then(() => {
                            const originalHTML = copyButton.innerHTML;
                            copyButton.innerHTML = '<i class="fas fa-check"></i>';
                            setTimeout(() => {
                                copyButton.innerHTML = originalHTML;
                            }, 2000);
                        });
                    });
                    codeHeader.appendChild(copyButton);
                    
                    // Replace the pre element with our custom structure
                    pre.parentNode.insertBefore(codeBlock, pre);
                    codeBlock.appendChild(codeHeader);
                    codeBlock.appendChild(pre);
                });
                
                // Sources
                if (message.sources && message.sources.length) {
                    const sourcesContainer = document.createElement('div');
                    sourcesContainer.className = 'sources-container';
                    
                    const sourcesTitle = document.createElement('div');
                    sourcesTitle.className = 'sources-title';
                    sourcesTitle.textContent = 'Sources:';
                    sourcesContainer.appendChild(sourcesTitle);
                    
                    const sourcesList = document.createElement('ul');
                    sourcesList.className = 'sources-list';
                    
                    message.sources.forEach(source => {
                        const sourceItem = document.createElement('li');
                        sourceItem.className = 'source-item';
                        
                        if (source.url) {
                            const link = document.createElement('a');
                            link.href = source.url;
                            link.target = '_blank';
                            link.textContent = source.title || source.url;
                            sourceItem.appendChild(link);
                        } else {
                            sourceItem.textContent = source.title || source.document || 'Unknown source';
                        }
                        
                        sourcesList.appendChild(sourceItem);
                    });
                    
                    sourcesContainer.appendChild(sourcesList);
                    messageContent.appendChild(sourcesContainer);
                }
            } else {
                // Plain text for user messages
                messageContent.textContent = message.content;
            }
            
            messageElement.appendChild(messageContent);
            
            messagesContainer.appendChild(messageElement);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function autoExpandTextarea() {
            const textarea = document.getElementById('query-input');
            
            textarea.addEventListener('input', function() {
                // Reset height to auto to get the correct scrollHeight
                this.style.height = 'auto';
                
                // Set new height based on scrollHeight (with max height of 200px)
                const newHeight = Math.min(this.scrollHeight, 200);
                this.style.height = `${newHeight}px`;
            });
        }
        
        // URL Processing
        document.getElementById('process-url-btn').addEventListener('click', async function() {
            const urlInput = document.getElementById('url-input');
            const statusDiv = document.getElementById('url-status');
            const url = urlInput.value.trim();
            
            if (!url) {
                // SECURITY NOTE: Using textContent is safer than innerHTML for simple messages.
                statusDiv.textContent = 'Please enter a URL';
                // Original: statusDiv.innerHTML = '<span class="text-red-500">Please enter a URL</span>';
                return;
            }
            
            // SECURITY NOTE: Using innerHTML here is okay for static loader, but be careful if message changes.
            statusDiv.innerHTML = '<span class="loader-sm"></span> <span>Processing URL...</span>';
            
            try {
                const response = await fetch('/process-url', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        url,
                        folder_id: document.getElementById('folder-select').value || null
                    }),
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // SECURITY WARNING: Using innerHTML with potentially unsanitized data (`result.characters_processed`) is risky. Use textContent.
                    statusDiv.textContent = `Success! Processed ${result.characters_processed} characters`;
                    // Original: statusDiv.innerHTML = `<span class="text-success">Success! Processed ${result.characters_processed} characters</span>`;
                    urlInput.value = '';
                } else {
                    // SECURITY WARNING: Using innerHTML with potentially unsanitized error message (`result.error`) is risky (XSS). Use textContent.
                    statusDiv.textContent = `Error: ${result.error}`;
                    // Original: statusDiv.innerHTML = `<span class="text-error">Error: ${result.error}</span>`;
                }
            } catch (error) {
                // SECURITY WARNING: Using innerHTML with potentially unsanitized error message (`error.message`) is risky (XSS). Use textContent.
                statusDiv.textContent = `Error: ${error.message}`;
                // Original: statusDiv.innerHTML = `<span class="text-error">Error: ${error.message}</span>`;
            }
        });
        
        // File Upload
        document.getElementById('upload-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('file-input');
            const statusDiv = document.getElementById('file-status');
            const folderSelect = document.getElementById('folder-select');
            
            if (!fileInput.files.length) {
                // SECURITY NOTE: Using textContent is safer.
                statusDiv.textContent = 'Please select a file';
                // Original: statusDiv.innerHTML = '<span class="text-error">Please select a file</span>';
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            
            if (folderSelect.value) {
                formData.append('folder_id', folderSelect.value);
            }
            
            // SECURITY NOTE: Using innerHTML here is okay for static loader, but be careful if message changes.
            statusDiv.innerHTML = '<span class="loader-sm"></span> <span>Uploading file...</span>';
            
            try {
                const response = await fetch('/upload-document', {
                    method: 'POST',
                    body: formData,
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // SECURITY WARNING: Using innerHTML with potentially unsanitized data (`result.characters_processed`, `file.name`) is risky. Use textContent.
                    statusDiv.textContent = `Success! Processed ${result.characters_processed} characters from "${file.name}"`;
                    // Original: statusDiv.innerHTML = `<span class="text-success">Success! Processed ${result.characters_processed} characters from "${file.name}"</span>`;
                    fileInput.value = '';
                } else {
                    // SECURITY WARNING: Using innerHTML with potentially unsanitized error message (`result.error`) is risky (XSS). Use textContent.
                    statusDiv.textContent = `Error: ${result.error}`;
                    // Original: statusDiv.innerHTML = `<span class="text-error">Error: ${result.error}</span>`;
                }
            } catch (error) {
                // SECURITY WARNING: Using innerHTML with potentially unsanitized error message (`error.message`) is risky (XSS). Use textContent.
                statusDiv.textContent = `Error: ${error.message}`;
                // Original: statusDiv.innerHTML = `<span class="text-error">Error: ${error.message}</span>`;
            }
        });
        
        // Function to copy code to clipboard
        window.copyCode = function(button) {
            const codeBlock = button.parentElement;
            const code = codeBlock.querySelector('code');
            const textToCopy = code.textContent;
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            });
        };
        
        function initializeFolderManagement() {
            const createFolderBtn = document.getElementById('create-folder-btn');
            const folderModal = document.getElementById('folder-modal');
            
            // Create folder button
            createFolderBtn.addEventListener('click', function() {
                // Reset form
                document.getElementById('folder-name').value = '';
                document.getElementById('folder-description').value = '';
                document.getElementById('parent-folder').value = '';
                
                // Update parent folder dropdown
                updateParentFolderOptions();
                
                // Show modal
                folderModal.classList.remove('hidden');
            });
            
            // Handle document view by folder
            document.getElementById('folder-list').addEventListener('click', function(e) {
                const folderItem = e.target.closest('.folder-item');
                if (folderItem) {
                    const folderId = folderItem.dataset.folderId;
                    toggleFolderDocuments(folderItem);
                }
            });
        }
        
        function initializeFolderModal() {
            const saveBtn = document.getElementById('folder-modal-save');
            
            saveBtn.addEventListener('click', async function() {
                const folderName = document.getElementById('folder-name').value.trim();
                const folderDescription = document.getElementById('folder-description').value.trim();
                const parentFolderId = document.getElementById('parent-folder').value;
                
                if (!folderName) {
                    alert('Please enter a folder name');
                    return;
                }
                
                try {
                    const response = await fetch('/create-folder', {  // Changed from /folders to /create-folder
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: folderName,
                            description: folderDescription,
                            parent_id: parentFolderId || null
                        }),
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        document.getElementById('folder-modal').classList.add('hidden');
                        loadFolders(); // Refresh folder list
                    } else {
                        alert(`Error: ${result.error}`);
                    }
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            });
        }
        
        async function loadFolders() {
            try {
                const response = await fetch('/get-folders');  // Changed from /folders to /get-folders
                const result = await response.json();
                
                if (result.success) {
                    folders = result.folders;
                    renderFolders();
                    updateFolderSelectOptions();
                }
            } catch (error) {
                console.error('Error loading folders:', error);
            }
        }
        
        function renderFolders() {
            const folderList = document.getElementById('folder-list');
            folderList.innerHTML = '';
            
            // Create a folder hierarchy
            const folderMap = {};
            const rootFolders = [];
            
            // First pass: create map
            folders.forEach(folder => {
                folderMap[folder.id] = {
                    ...folder,
                    children: []
                };
            });
            
            // Second pass: build hierarchy
            folders.forEach(folder => {
                if (folder.parent_id && folderMap[folder.parent_id]) {
                    folderMap[folder.parent_id].children.push(folderMap[folder.id]);
                } else {
                    rootFolders.push(folderMap[folder.id]);
                }
            });
            
            // Render root folders
            rootFolders.forEach(folder => {
                renderFolderItem(folderList, folder, 0);
            });
        }
        
        function renderFolderItem(container, folder, level) {
            const folderItem = document.createElement('div');
            folderItem.className = 'folder-item';
            folderItem.dataset.folderId = folder.id;
            folderItem.dataset.level = level;
            
            const padding = level * 12;
            
            // Folder header
            const folderHeader = document.createElement('div');
            folderHeader.className = 'folder-header';
            folderHeader.style.paddingLeft = `${padding}px`;
            
            // Expand/collapse icon
            const expandIcon = document.createElement('i');
            expandIcon.className = folder.children.length ? 'fas fa-chevron-right folder-expand' : 'fas fa-chevron-right folder-expand invisible';
            folderHeader.appendChild(expandIcon);
            
            // Folder icon
            const folderIcon = document.createElement('i');
            folderIcon.className = 'fas fa-folder';
            folderHeader.appendChild(folderIcon);
            
            // Folder name
            const folderName = document.createElement('span');
            folderName.className = 'folder-name';
            folderName.textContent = folder.name;
            folderHeader.appendChild(folderName);
            
            folderItem.appendChild(folderHeader);
            
            // Documents container
            const docsContainer = document.createElement('div');
            docsContainer.className = 'folder-documents hidden';
            docsContainer.style.paddingLeft = `${padding + 20}px`;
            folderItem.appendChild(docsContainer);
            
            // Children container
            const childrenContainer = document.createElement('div');
            childrenContainer.className = 'folder-children hidden';
            
            if (folder.children.length) {
                folder.children.forEach(child => {
                    renderFolderItem(childrenContainer, child, level + 1);
                });
                folderItem.appendChild(childrenContainer);
            }
            
            container.appendChild(folderItem);
        }
        
        function toggleFolderDocuments(folderItem) {
            const folderId = folderItem.dataset.folderId;
            const expandIcon = folderItem.querySelector('.folder-expand');
            const docsContainer = folderItem.querySelector('.folder-documents');
            const childrenContainer = folderItem.querySelector('.folder-children');
            
            // Toggle children visibility
            if (childrenContainer) {
                childrenContainer.classList.toggle('hidden');
            }
            
            // Toggle documents visibility
            docsContainer.classList.toggle('hidden');
            
            // Rotate chevron icon
            if (!expandIcon.classList.contains('invisible')) {
                expandIcon.classList.toggle('rotate-90');
            }
            
            // Load documents for this folder if not already loaded
            if (!docsContainer.childNodes.length) {
                loadFolderDocuments(folderId, docsContainer);
            }
        }
        
        async function loadFolderDocuments(folderId, container) {
            try {
                const response = await fetch(`/get-documents?folder_id=${folderId}`);  // Changed endpoint
                const result = await response.json();
                
                if (result.success) {
                    const documents = result.documents;
                    
                    if (documents.length === 0) {
                        const emptyMessage = document.createElement('div');
                        emptyMessage.className = 'text-sm text-gray-500 pl-2';
                        emptyMessage.textContent = 'No documents in this folder';
                        container.appendChild(emptyMessage);
                        return;
                    }
                    
                    documents.forEach(doc => {
                        const docItem = document.createElement('div');
                        docItem.className = 'doc-item';
                        docItem.dataset.docId = doc.id;
                        
                        // Document icon based on file type
                        const docIcon = document.createElement('i');
                        let iconClass = 'fas fa-file-alt'; // default
                        
                        if (doc.filename) {
                            const ext = doc.filename.split('.').pop().toLowerCase();
                            if (['pdf'].includes(ext)) {
                                iconClass = 'fas fa-file-pdf';
                            } else if (['md', 'markdown'].includes(ext)) {
                                iconClass = 'fas fa-file-code';
                            } else if (['txt', 'text'].includes(ext)) {
                                iconClass = 'fas fa-file-alt';
                            }
                        }
                        
                        docIcon.className = iconClass;
                        docItem.appendChild(docIcon);
                        
                        // Document name
                        const docName = document.createElement('span');
                        docName.className = 'doc-name';
                        docName.textContent = doc.title || doc.filename || `Document ${doc.id}`;
                        docItem.appendChild(docName);
                        
                        // Document actions
                        const docActions = document.createElement('div');
                        docActions.className = 'doc-actions';
                        
                        // View document
                        const viewBtn = document.createElement('button');
                        viewBtn.className = 'doc-action-btn';
                        viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                        viewBtn.title = 'View document';
                        viewBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            viewDocument(doc.id);
                        });
                        docActions.appendChild(viewBtn);
                        
                        docItem.appendChild(docActions);
                        container.appendChild(docItem);
                    });
                }
            } catch (error) {
                console.error(`Error loading documents for folder ${folderId}:`, error);
                const errorMessage = document.createElement('div');
                errorMessage.className = 'text-sm text-red-500 pl-2';
                errorMessage.textContent = 'Error loading documents';
                container.appendChild(errorMessage);
            }
        }
        
        function updateParentFolderOptions() {
            const parentFolderSelect = document.getElementById('parent-folder');
            parentFolderSelect.innerHTML = '<option value="">None (Top Level)</option>';
            
            folders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                option.textContent = folder.name;
                parentFolderSelect.appendChild(option);
            });
        }
        
        function updateFolderSelectOptions() {
            const folderSelect = document.getElementById('folder-select');
            folderSelect.innerHTML = '<option value="">Select Folder (Optional)</option>';
            
            folders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                option.textContent = folder.name;
                folderSelect.appendChild(option);
            });
        }
        
        function viewDocument(docId) {
            // TODO: Implement document viewing functionality
            // This could open a modal with the document content or navigate to a document view page
            console.log(`View document: ${docId}`);
        }
        
        function initializeChat() {
            const newChatBtn = document.getElementById('new-chat-btn');
            const queryInput = document.getElementById('query-input');
            const queryBtn = document.getElementById('query-btn');
            const renameBtn = document.getElementById('rename-chat-btn');
            const deleteBtn = document.getElementById('delete-chat-btn');
            
            // New chat button
            newChatBtn.addEventListener('click', function() {
                createNewChat();
            });
            
            // Send query on Enter (but not with Shift+Enter for multiline)
            queryInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendQuery();
                }
            });
            
            // Send query button
            queryBtn.addEventListener('click', function() {
                sendQuery();
            });
            
            // Rename chat button
            renameBtn.addEventListener('click', function() {
                const renameModal = document.getElementById('rename-modal');
                const newChatTitleInput = document.getElementById('new-chat-title');
                const currentTitle = document.getElementById('current-chat-title').textContent;
                
                newChatTitleInput.value = currentTitle;
                renameModal.classList.remove('hidden');
                
                // Close the dropdown menu
                document.getElementById('more-actions-menu').classList.add('hidden');
            });
            
            // Delete chat button
            deleteBtn.addEventListener('click', function() {
                const confirmModal = document.getElementById('confirm-modal');
                const confirmTitle = document.getElementById('confirm-modal-title');
                const confirmMessage = document.getElementById('confirm-modal-message');
                const confirmBtn = document.getElementById('confirm-modal-confirm');
                
                confirmTitle.textContent = 'Delete Chat';
                confirmMessage.textContent = 'Are you sure you want to delete this chat? This action cannot be undone.';
                
                // Setup confirm button callback
                confirmBtn.callback = function() {
                    deleteCurrentChat();
                };
                
                confirmModal.classList.remove('hidden');
                
                // Close the dropdown menu
                document.getElementById('more-actions-menu').classList.add('hidden');
            });
            
            // Initialize export button
            document.getElementById('export-btn').addEventListener('click', function() {
                if (!currentChatId) {
                    alert('No chat to export');
                return;
            }
            
                document.getElementById('export-modal').classList.remove('hidden');
            });
            
            // Initialize export functionality
            initializeExportModal();
        }
        
        function initializeExportModal() {
            const exportBtn = document.getElementById('export-modal-save');
            
            exportBtn.addEventListener('click', async function() {
                const format = document.getElementById('export-format').value;
                const content = document.getElementById('export-content').value;
                
                if (!currentChatId) {
                    alert('No chat to export');
                    return;
                }
                
                try {
                    const response = await fetch(`/chats/${currentChatId}/export`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                        body: JSON.stringify({
                            format: format,
                            content: content
                        }),
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const fileName = `chat_export.${format}`;
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        a.click();
                        
                        URL.revokeObjectURL(url);
                        document.getElementById('export-modal').classList.add('hidden');
                    } else {
                        const error = await response.json();
                        alert(`Error exporting chat: ${error.error}`);
                    }
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            });
        }
        
        function initializeRenameModal() {
            const saveBtn = document.getElementById('rename-modal-save');
            
            saveBtn.addEventListener('click', async function() {
                const newTitle = document.getElementById('new-chat-title').value.trim();
                
                if (!newTitle) {
                    alert('Please enter a title');
                    return;
                }
                
                if (!currentChatId) {
                    alert('No active chat to rename');
                    return;
                }
                
                try {
                    const response = await fetch(`/rename-chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: currentChatId,
                            title: newTitle
                        }),
                    });
                    
                    const result = await response.json();
                
                if (result.success) {
                        document.getElementById('current-chat-title').textContent = newTitle;
                        document.getElementById('rename-modal').classList.add('hidden');
                        
                        // Update the chat in the sidebar
                        const chatItem = document.querySelector(`.chat-item[data-chat-id="${currentChatId}"]`);
                        if (chatItem) {
                            chatItem.querySelector('.chat-item-title').textContent = newTitle;
                        }
                            } else {
                        alert(`Error: ${result.error}`);
                    }
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            });
        }
        
        function initializeConfirmModal() {
            const confirmModal = document.getElementById('confirm-modal');
            const confirmBtn = document.getElementById('confirm-modal-confirm');
            const cancelBtn = document.getElementById('confirm-modal-cancel');
            const closeBtn = document.getElementById('confirm-modal-close');
            
            closeBtn.addEventListener('click', function() {
                confirmModal.classList.add('hidden');
            });
            
            cancelBtn.addEventListener('click', function() {
                confirmModal.classList.add('hidden');
            });
            
            confirmBtn.addEventListener('click', function() {
                // This will be set dynamically when the modal is opened
                if (confirmBtn.callback) {
                    confirmBtn.callback();
                }
                confirmModal.classList.add('hidden');
            });
        }
        
        async function loadChats() {
            try {
                const response = await fetch('/get-chats');  // Changed from /chats to /get-chats
                const result = await response.json();
                
                if (result.success) {
                    renderChatList(result.chats);
                }
            } catch (error) {
                console.error('Error loading chats:', error);
            }
        }
        
        function renderChatList(chats) {
            const chatList = document.getElementById('chat-list');
            
            // Clear previous items except the title
            const title = chatList.querySelector('.nav-title');
            chatList.innerHTML = '';
            chatList.appendChild(title);
            
            if (chats.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'text-sm text-gray-500 p-2';
                emptyMessage.textContent = 'No recent chats';
                chatList.appendChild(emptyMessage);
                return;
            }
            
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.dataset.chatId = chat.id;
                
                const chatIcon = document.createElement('i');
                chatIcon.className = 'fas fa-comments';
                chatItem.appendChild(chatIcon);
                
                const chatTitle = document.createElement('span');
                chatTitle.className = 'chat-item-title';
                chatTitle.textContent = chat.title || `Chat ${chat.id}`;
                chatItem.appendChild(chatTitle);
                
                chatItem.addEventListener('click', function() {
                    loadChat(chat.id);
                });
                
                chatList.appendChild(chatItem);
            });
        }
        
        async function createNewChat() {
            try {
                const response = await fetch('/new-chat');  // Changed from /chats to /new-chat
                const result = await response.json();
                
                if (result.success) {
                    currentChatId = result.chat_id;
                    
                    // Update UI
                    document.getElementById('current-chat-title').textContent = 'New Chat';
                    document.getElementById('welcome-screen').classList.remove('hidden');
                    document.getElementById('messages-container').classList.add('hidden');
                    document.getElementById('messages-container').innerHTML = '';
                    
                    // Update chat list
                    loadChats();
                    } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function loadChat(chatId) {
            try {
                const response = await fetch(`/get-chat-history`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId
                    }),
                });
                const result = await response.json();
                
                if (result.success) {
                    currentChatId = chatId;
                    
                    // Get the chat details to update title
                    const chat = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
                    const chatTitle = chat ? chat.querySelector('.chat-item-title').textContent : `Chat ${chatId}`;
                    
                    // Update UI
                    document.getElementById('current-chat-title').textContent = chatTitle;
                    document.getElementById('welcome-screen').classList.add('hidden');
                    
                    const messagesContainer = document.getElementById('messages-container');
                    messagesContainer.innerHTML = '';
                    messagesContainer.classList.remove('hidden');
                    
                    // Render messages
                    if (result.history && result.history.length > 0) {
                        result.history.forEach(message => {
                            renderMessage(message);
                        });
                    }
                    
                    // Highlight active chat
                    document.querySelectorAll('.chat-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    const chatItem = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
                    if (chatItem) {
                        chatItem.classList.add('active');
                    }
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function deleteCurrentChat() {
            if (!currentChatId) {
                alert('No active chat to delete');
                return;
            }
            
            try {
                const response = await fetch(`/delete-chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: currentChatId
                    }),
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update UI
                    createNewChat(); // Create a new chat after deleting
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
    </script>
</body>
</html>